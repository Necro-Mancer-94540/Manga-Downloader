<html>

<head>
    <title>
        Manga Downloader
    </title>
</head>

<body>
    <p>
        Downloading...
    </p>
    <script src="../zip-maker.js"></script>
    <script>
        var links = [], linksPage = [];
        <% for( var i = 0; i < result.length; i++) { %>
            <% for( var j = 0; j < result[i].length; j++) { %>
                linksPage.push("<%= result[i][j] %>");
            <% } %>
            links.push(linksPage);
            linksPage = [];
        <% } %>        
        const zip = new JSZip();
        links.forEach((currentChapter, indexChapter) => {
            var chapter = zip.folder(indexChapter + 1);
            currentChapter.forEach((currentPage, indexPage) => {
                var page = currentPage.replace(/.*\//g, "");
                chapter.file(page, urlToPromise(currentPage), {
                    binary: true
                });                
            });            
        });
        zip.generateAsync({
                type: "blob"
            })
            .then(function callback(blob) {
                saveAs(blob, "manga.zip");
            });
        function urlToPromise(url) {
            return new Promise(function (resolve, reject) {
                JSZipUtils.getBinaryContent("https://cors-anywhere.herokuapp.com/" + url, function (err, data) {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
        }
    </script>
</body>

</html>